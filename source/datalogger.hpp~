#include "param_set.hpp"
#include "model.hpp"
#include "specie.hpp"
#include "cell_param.hpp"
#include "simulation.hpp"
#include "reaction.hpp"
#include "concentration_level.hpp"
#include "baby_cl.hpp"
#include <vector>
#include <array>
#include <iostream>
#include <fstream>
#include "observable.hpp"

using namespace std;


class DataLogger : public  Observer {
	
	int analysis_interval; //number of steps to record.
	
	RATETYPE*** datalog;

	int last_sim_time;
	int last_log_time;
	
	int species;
	int contexts;
	int steps;
	
	simulation* sim;	

	public:

	DataLogger();
	DataLogger(int = 1);

	DataLogger(simulation *sub, int analysis_gran) {
		
		sim = sub;
		sim->addObserver(this);
		analysis_interval = analysis_gran;
		
		species = NUM_SPECIES;
		contexts = sim->_cells_total;
		steps = (sim->time_total/sim->_step_size)/analysis_interval; 
		
		datalog = new RATETYPE**[species];
		for (int i = 0; i < species; i++){
			datalog[i] = new RATETYPE*[contexts];
			for (int j=0; j<contexts; j++){
				datalog[i][j] = new RATETYPE[steps];
			}
		}
		
		last_sim_time = 0;
		last_log_time = 0;
	}

	void update() {
		
		for (int t = last_sim_time; t<sim->_j; t+=analysis_interval){
			for (int s = 0; s<species; s++){			
				for (int c = 0; c<contexts; c++){ //Haha "c++" ...
					datalog[s][c][last_log_time] = sim->_baby_cl[s][t][c];
				}
			}
			last_log_time++;
		}
	}
	
	void testDataLogger();
	
	void reallocateData(int last_relevant_time);

	void exportDataToFile(ofstream outFile){
		
		outFile.open("dataOut.txt");
		for (int c = 0; c < contexts; c++){
			outFile<<"    Cell "<<c<<endl;
			for (int s = 0; s < species; s++){
				outFile<<"    Specie "<<s;
			}
			outFile<<endl;
			for (int t = 0; t<steps; t++){
				outFile<<"Time "<<t*analysis_interval;
				for (int s = 0; s<species; s++){
					outFile<<std::setprecision(5)<<datalog[s][c][t]<<"    ";
				}
				outFile<<endl;
			}
		}
	}
	
	void importFileToData(ifstream inFile);
};
